---
import { getTranslations } from '../i18n/translations';

interface Props {
  lang?: 'en' | 'de';
}

const { lang = (Astro.currentLocale as 'en' | 'de') || 'en' } = Astro.props;
const t = getTranslations(lang);

// Use absolute paths for the privacy policy to ensure it works from any subpage
const privacyUrl = '/privacy';
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 z-50 transform translate-y-full transition-transform duration-500 ease-in-out p-4 md:p-6" style="display: none;">
  <div class="max-w-4xl mx-auto bg-white/95 border border-slate-200 shadow-2xl rounded-2xl p-6 md:p-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 backdrop-blur-xl">
    <div class="flex-1 text-slate-600">
      <h3 class="text-xl font-bold text-slate-800 mb-2">{t.cookieBanner.title}</h3>
      <p class="text-sm leading-relaxed text-slate-500 font-medium">
        {t.cookieBanner.description}
        <a href={privacyUrl} class="text-[#F05D23] hover:text-[#d63c6b] underline underline-offset-2 ml-1 transition-colors font-semibold">
          {t.cookieBanner.privacyLink}
        </a>
      </p>
    </div>
    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto shrink-0">
      <button id="cookie-decline" class="px-6 py-2.5 rounded-xl bg-slate-50 hover:bg-slate-100 text-slate-600 transition-colors font-semibold border border-slate-200 text-sm">
        {t.cookieBanner.decline}
      </button>
      <button id="cookie-accept" class="px-6 py-2.5 rounded-xl bg-[#F05D23] hover:bg-[#e04c12] text-white transition-all font-bold shadow-sm text-sm">
        {t.cookieBanner.accept}
      </button>
    </div>
  </div>
</div>

<script>
  // Setup Google Analytics injection
  const GA_TRACKING_ID = 'G-5WFNG9Y90K';

  function loadGoogleAnalytics() {
    // Only load if not already loaded
    if (document.getElementById('ga-script')) return;

    // Load the gtag script
    const script = document.createElement('script');
    script.id = 'ga-script';
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_TRACKING_ID}`;
    document.head.appendChild(script);

    // Initialize gtag
    const w = window as any;
    w.dataLayer = w.dataLayer || [];
    function gtag(){w.dataLayer.push(arguments);}
    w.gtag = gtag;
    w.gtag('js', new Date());
    w.gtag('config', GA_TRACKING_ID);
  }

  // Handle banner logic
  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('cookie-banner');
    const acceptBtn = document.getElementById('cookie-accept');
    const declineBtn = document.getElementById('cookie-decline');
    
    // Check current consent status
    const consent = localStorage.getItem('cookie-consent');
    
    if (consent === 'true') {
      loadGoogleAnalytics();
    } else if (consent === null) {
      // Show banner if no consent choice has been made
      if (banner) {
        banner.style.display = 'block';
        // Small delay to ensure display: block is applied before animation
        setTimeout(() => {
          banner.classList.remove('translate-y-full');
        }, 50);
      }
    }

    const hideBanner = () => {
      if (banner) {
        banner.classList.add('translate-y-full');
        setTimeout(() => {
          banner.style.display = 'none';
        }, 500); // Wait for transition out
      }
    };

    if (acceptBtn) {
      acceptBtn.addEventListener('click', () => {
        localStorage.setItem('cookie-consent', 'true');
        loadGoogleAnalytics();
        hideBanner();
      });
    }

    if (declineBtn) {
      declineBtn.addEventListener('click', () => {
        localStorage.setItem('cookie-consent', 'false');
        hideBanner();
      });
    }
  });
</script>
